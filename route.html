<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏùºÎ≥∏ 3Î∞ï 4Ïùº ÏôÑÎ≤Ω Í∞ÄÏù¥Îìú (Ï†ëÍ∏∞ Í∏∞Îä• Ï∂îÍ∞Ä)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; }
        #map { height: 100%; width: 100%; z-index: 0; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* Marker Animations */
        .pulse-icon {
            background-color: #ef4444; border-radius: 50%; width: 12px; height: 12px;
            box-shadow: 0 0 0 rgba(239, 68, 68, 0.4); animation: pulse 2s infinite;
        }
        .pulse-icon-blue {
            background-color: #3b82f6; border-radius: 50%; width: 12px; height: 12px;
            box-shadow: 0 0 0 rgba(59, 130, 246, 0.4); animation: pulse-blue 2s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        .schedule-item { transition: all 0.2s; border-left: 3px solid transparent; }
        .schedule-item:hover { transform: translateX(4px); border-left-color: #cbd5e1; }
        .active-card { border-left-color: #3b82f6 !important; background-color: #eff6ff !important; }
        
        .split-badge-a { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .split-badge-b { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        
        /* Custom Popup */
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 280px !important; }

        /* Collapse Animation */
        #info-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding 0.3s;
            overflow: hidden;
        }
        .collapsed-content {
            max-height: 0 !important;
            opacity: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }
        .rotate-180 { transform: rotate(180deg); }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- Mobile Header -->
    <div class="md:hidden bg-indigo-600 text-white p-3 shadow-md z-20 flex justify-between items-center shrink-0">
        <h1 class="font-bold text-lg">üáØüáµ 3Î∞ï 4Ïùº ÏùºÏ†ïÌëú</h1>
        <span id="total-cost-mobile" class="text-xs bg-indigo-700 px-2 py-1 rounded font-mono"></span>
    </div>

    <!-- Sidebar -->
    <div class="w-full md:w-1/3 flex flex-col h-1/2 md:h-full bg-white shadow-xl z-10 relative">
        <div class="hidden md:block p-5 bg-indigo-600 text-white shadow-md shrink-0">
            <h1 class="text-2xl font-bold">üáØüáµ Japan Travel</h1>
            <p class="text-indigo-100 text-sm mt-1">Ïò§ÏÇ¨Ïπ¥ ‚Ä¢ ÍµêÌÜ† ‚Ä¢ ÎèÑÏøÑ (1/28 ~ 1/31)</p>
            <div id="total-cost-desktop" class="mt-3 inline-block bg-indigo-800 px-3 py-1 rounded-full text-xs font-mono font-bold tracking-wide"></div>
        </div>

        <!-- Date Tabs -->
        <div class="flex overflow-x-auto bg-white border-b shrink-0">
            <button onclick="selectDay(0)" id="tab-0" class="flex-1 py-3 text-center border-b-2 text-sm font-semibold text-gray-500 hover:text-indigo-600">1ÏùºÏ∞®<br><span class="text-xs font-normal">Ïò§ÏÇ¨Ïπ¥</span></button>
            <button onclick="selectDay(1)" id="tab-1" class="flex-1 py-3 text-center border-b-2 text-sm font-semibold text-gray-500 hover:text-indigo-600">2ÏùºÏ∞®<br><span class="text-xs font-normal">USJ</span></button>
            <button onclick="selectDay(2)" id="tab-2" class="flex-1 py-3 text-center border-b-2 text-sm font-semibold text-gray-500 hover:text-indigo-600">3ÏùºÏ∞®<br><span class="text-xs font-normal">ÍµêÌÜ†</span></button>
            <button onclick="selectDay(3)" id="tab-3" class="flex-1 py-3 text-center border-b-2 text-sm font-semibold text-gray-500 hover:text-indigo-600">4ÏùºÏ∞®<br><span class="text-xs font-normal">ÎèÑÏøÑ</span></button>
        </div>

        <!-- Schedule List -->
        <div id="schedule-list" class="flex-1 overflow-y-auto p-2 md:p-4 space-y-3 bg-slate-50 pb-20 md:pb-5"></div>
        
        <!-- Split Legend (Day 4 only) -->
        <div id="split-legend" class="absolute bottom-0 w-full bg-white border-t p-2 text-xs flex justify-around hidden shadow-[0_-5px_15px_rgba(0,0,0,0.1)]">
            <div class="flex items-center gap-1"><span class="w-3 h-3 bg-red-500 rounded-full"></span> <span>AÌåÄ: Î©òÎèÑÏΩîÎ°ú ÌòºÎã§</span></div>
            <div class="flex items-center gap-1"><span class="w-3 h-3 bg-green-500 rounded-full"></span> <span>BÌåÄ: Ìò∏ÌÉÄÌÖå ÎπÑÏöîÎ¶¨</span></div>
        </div>
    </div>

    <!-- Map Container -->
    <div class="w-full md:w-2/3 h-1/2 md:h-full relative">
        <div id="map"></div>
        
        <!-- Info Overlay (Collapsible) -->
        <div id="map-info" class="absolute top-5 right-5 bg-white rounded-xl shadow-2xl hidden md:flex flex-col z-[400] w-80 border border-gray-100 transition-all duration-300 opacity-0 translate-y-[-20px]">
            <!-- Header -->
            <div class="flex justify-between items-center p-4 bg-gray-50 border-b cursor-pointer rounded-t-xl" onclick="toggleInfo()">
                <h3 id="info-title" class="font-bold text-gray-800 truncate pr-2"></h3>
                <div class="flex gap-3 text-gray-400">
                    <button id="toggle-icon" class="hover:text-blue-500 transition-transform duration-300"><i class="fas fa-chevron-up"></i></button>
                    <button onclick="event.stopPropagation(); closeInfo()" class="hover:text-red-500 transition-colors"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <!-- Content Body -->
            <div id="info-content" class="text-sm text-gray-600 space-y-2 max-h-[60vh] overflow-y-auto p-4 bg-white rounded-b-xl"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. DATA: Locations & Detailed POIs ---
        const LOC = {
            kix: [34.4325, 135.2304],
            nambaStn: [34.6618, 135.5021],
            osakaHotel: [34.6634, 135.4975], 
            tendonMakino: [34.6682, 135.5036],
            dendenTown: [34.6593, 135.5057],
            glicoMan: [34.6687, 135.5013],
            kuromon: [34.6654, 135.5074],
            aburiya: [34.6690, 135.5015],
            dotonbori: [34.6687, 135.5013],
            sumibi: [34.6675, 135.5000],
            usj: [34.6654, 135.4323],
            fukutaro: [34.6657, 135.5042],
            fushimiInari: [34.9671, 135.7726],
            yamamoto: [35.0157, 135.7825],
            kiyomizu: [34.9948, 135.7850],
            sannenzaka: [34.9960, 135.7820],
            kamoRiver: [35.0080, 135.7710],
            hideatora: [35.0050, 135.7700],
            pontocho: [35.0062, 135.7716],
            gion: [35.0035, 135.7750],
            yasohachi: [35.0055, 135.7710],
            shinOsaka: [34.7334, 135.5003],
            tokyoStn: [35.6812, 139.7671],
            uenoHotel: [35.7122, 139.7758],
            kappabashi: [35.7153, 139.7895],
            sensoji: [35.7147, 139.7966],
            akihabara: [35.6983, 139.7730],
            ameyoko: [35.7088, 139.7741],
            honda: [35.6997, 139.7754], 
            hotate: [35.6963, 139.7856], 
            gigo: [35.6994, 139.7712] 
        };

        const POIS = {
            denden: [
                { name: "Ï°∞Ïã† ÏäàÌçº ÌÇ§Ï¶à ÎûúÎìú", pos: [34.6595, 135.5055] },
                { name: "Ï†ïÍ∏Ä (Jungle)", pos: [34.6600, 135.5060] },
                { name: "ÏäàÌçº Ìè¨ÌÖåÏù¥ÌÜ†", pos: [34.6610, 135.5058] },
                { name: "Ïï†ÎãàÎ©îÏù¥Ìä∏", pos: [34.6605, 135.5050] },
                { name: "Ïä§Î£®Í∞ÄÏïº", pos: [34.6590, 135.5052] },
                { name: "ÎùºÏã†Î∞ò", pos: [34.6598, 135.5056] },
                { name: "Ïò§ÌÉÄÎ°úÎìú", pos: [34.6590, 135.5065] }
            ],
            kuromon: [
                { name: "ÎßàÍµ¨Î°úÏïº Ïø†Î°úÍ∏¥(Ï∞∏Ïπò)", pos: [34.6655, 135.5075] },
                { name: "Í∞ÄÎ¶¨ÎπÑ&Ïû•Ïñ¥ Íµ¨Ïù¥", pos: [34.6653, 135.5073] },
                { name: "ÎßàÎ£®Ï†† ÏãùÏú°Ï†ê", pos: [34.6652, 135.5072] },
                { name: "ÌôîÏù¥Ìä∏ Îî∏Í∏∞", pos: [34.6650, 135.5076] }
            ],
            usj: [
                { name: "ÏäàÌçº ÎãåÌÖêÎèÑ ÏõîÎìú", pos: [34.6660, 135.4290] },
                { name: "ÏúÑÏ†ÄÎî© ÏõîÎìú (Ìï¥Î¶¨Ìè¨ÌÑ∞)", pos: [34.6640, 135.4280] },
                { name: "ÎØ∏ÎãàÏñ∏ ÌååÌÅ¨", pos: [34.6620, 135.4310] },
                { name: "Ï•¨ÎùºÍ∏∞ Í≥µÏõê", pos: [34.6625, 135.4300] }
            ],
            fushimi: [
                { name: "ÏÑºÎ≥∏ ÌÜ†Î¶¨Ïù¥", pos: [34.9665, 135.7750] },
                { name: "Ïò§Ïø†ÏÉ§ Î¥âÎ∞∞ÏÜå", pos: [34.9660, 135.7760] },
                { name: "Í≥∞Ïùò Ïà≤ (Ïø†ÎßàÌÉÄÏπ¥ÏÉ§)", pos: [34.9655, 135.7780] },
                { name: "ÏöîÏ∏†Ï∏†ÏßÄ", pos: [34.9650, 135.7800] }
            ],
            kiyomizu: [
                { name: "Î≥∏Îãπ (Î¨¥ÎåÄ)", pos: [34.9948, 135.7850] },
                { name: "Ïò§ÌÜ†ÏôÄ Ìè≠Ìè¨", pos: [34.9945, 135.7852] }
            ],
            sannenzaka: [
                { name: "Ïä§ÌÉÄÎ≤ÖÏä§ (Îã§Îã§ÎØ∏)", pos: [34.9985, 135.7805] },
                { name: "ÎèôÍµ¨Î¶¨ Í≥µÌôîÍµ≠", pos: [34.9965, 135.7815] },
                { name: "ÎßàÎ•¥Î∏îÎûëÏäà (Ï∞®ÎÖ∏Ïπ¥)", pos: [34.9958, 135.7825] },
                { name: "ÏöîÏßÄÏïº", pos: [34.9962, 135.7818] },
                { name: "ÏãúÏπòÎØ∏Ïïº ÌòºÌè¨", pos: [34.9955, 135.7828] },
                { name: "Ïù¥ÎÖ∏Îã§ Ïª§Ìîº", pos: [34.9960, 135.7810] },
                { name: "Ïò§Ïπ¥Î£® (Ïπ¥Î†àÏö∞Îèô)", pos: [35.0038, 135.7745] } 
            ],
            kamo_cafes: [
                { name: "Ïä§ÌÉÄÎ≤ÖÏä§ ÏÇ∞Ï°∞Ïò§ÌïòÏãú", pos: [35.0090, 135.7718] },
                { name: "Ïπ¥ÏôÄ Ïπ¥Ìéò (Kawa)", pos: [35.0015, 135.7705] },
                { name: "ÏÇ¥Î°± Îìú Î°úÏñÑ", pos: [35.0110, 135.7715] },
                { name: ".S (Îã∑ ÏóêÏä§)", pos: [35.0130, 135.7725] },
                { name: "ÏôÄÏù¥ÌîÑ Ïï§ ÌóàÏ¶àÎ≤àÎìú", pos: [35.0450, 135.7590] }
            ],
            gion: [
                { name: "ÌïòÎÇòÎØ∏ÏΩîÏßÄ (Î©îÏù∏)", pos: [35.0035, 135.7750] },
                { name: "ÏïºÏÇ¨Ïπ¥ Ïã†ÏÇ¨", pos: [35.0036, 135.7785] },
                { name: "Í∏∞Ïò® Ï∏†ÏßÄÎ¶¨ (ÌååÎ•¥Ìéò)", pos: [35.0038, 135.7742] },
                { name: "Ïπ¥Í∏∞Ï†† ÏöîÏãúÌõÑÏÇ¨", pos: [35.0039, 135.7748] },
                { name: "Í∏∞Ïò® ÌÇ§ÎÇòÎÇò", pos: [35.0025, 135.7755] },
                { name: "ÌÉÄÏ∏†ÎØ∏ Îã§Î¶¨", pos: [35.0055, 135.7735] },
                { name: "ÎØ∏ÎÇòÎØ∏Ï¢å (Í∑πÏû•)", pos: [35.0040, 135.7725] }
            ],
            pontocho: [
                { name: "Ìè∞ÌÜ†Ï¥à Í≥®Î™©", pos: [35.0062, 135.7716] },
                { name: "Ïú†Ï¶àÍ≤ê (Ïú†ÏûêÎÇòÎ≤†)", pos: [35.0058, 135.7715] },
                { name: "Î™®Ï∏†ÎÇòÎ≤† ÌÜ†ÎùºÏïº", pos: [35.0060, 135.7715] },
                { name: "ÍµêÌÜ† ÏïºÌÇ§ÎãàÏø† ÏóîÏóî", pos: [35.0045, 135.7712] },
                { name: "Í∞ìÌåå Ïä§Ïãú", pos: [35.0050, 135.7713] }
            ],
            sensoji: [
                { name: "Ïπ¥ÎØ∏ÎÇòÎ¶¨Î™¨ (Ï†úÎì±)", pos: [35.7111, 139.7964] },
                { name: "Ìò∏Ï°∞Î™¨", pos: [35.7138, 139.7966] },
                { name: "Î≥∏Îãπ (Í¥ÄÏùåÎãπ)", pos: [35.7147, 139.7966] },
                { name: "Ïò§Ï∏µÌÉë", pos: [35.7142, 139.7958] },
                { name: "ÏïÑÏÇ¨Ïø†ÏÇ¨ Ïã†ÏÇ¨", pos: [35.7150, 139.7972] },
                { name: "Ïò§ÎØ∏Ïø†ÏßÄ Íµ¨Ïó≠", pos: [35.7144, 139.7962] },
                { name: "ÎÇòÎç∞Î≥¥ÌÜ†ÏºÄ", pos: [35.7145, 139.7960] },
                { name: "ÌÇ§Î¨¥ÎùºÏïº (Ïù∏ÌòïÎπµ)", pos: [35.7140, 139.7965] },
                { name: "ÌÇ§ÎπÑÎãπÍ≥† ÏïÑÏ¶àÎßà", pos: [35.7125, 139.7965] },
                { name: "ÏïÑÏÇ¨Ïø†ÏÇ¨ ÏΩîÏΩîÎÖ∏Ïóê", pos: [35.7141, 139.7965] },
                { name: "ÌôîÏõîÎãπ (Î©îÎ°†Îπµ)", pos: [35.7135, 139.7950] },
                { name: "Ïã§ÌÅ¨ Ìë∏Îî©", pos: [35.7118, 139.7968] },
                { name: "ÌõÑÎÇòÏôÄ (ÏñëÍ∞±)", pos: [35.7120, 139.7964] },
                { name: "Ïµ∏Ïπ≠ Î™®ÎÇòÏπ¥", pos: [35.7128, 139.7965] }
            ],
            ameyoko: [
                { name: "ÏãúÎ¨¥Îùº ÏáºÌÖê (Ï¥àÏΩúÎ¶ø)", pos: [35.7095, 139.7745] },
                { name: "ÎãàÏø†ÎÖ∏ Ïò§Ïò§ÏïºÎßà", pos: [35.7100, 139.7742] },
                { name: "ÎØ∏ÎÇòÌÜ†Ïïº (ÎçÆÎ∞•)", pos: [35.7092, 139.7743] },
                { name: "Îã§Ïù¥ÌÜ†Î•ò (Ïù¥ÏûêÏπ¥Ïïº)", pos: [35.7098, 139.7744] },
                { name: "ÏïºÌÇ§ÌÜ†Î¶¨ Î∂ÑÎùºÏø†", pos: [35.7097, 139.7744] },
                { name: "ÌñêÏπ¥Ïóî (Í≥ºÏùº)", pos: [35.7090, 139.7742] },
                { name: "ABCÎßàÌä∏ Î≥∏Ï†ê", pos: [35.7088, 139.7745] },
                { name: "ÎãàÌÇ§Ïùò Í≥ºÏûê", pos: [35.7085, 139.7743] }
            ],
            kappabashi: [
                { name: "ÎãàÏù¥ÎØ∏ ÏãùÍ∏∞", pos: [35.7100, 139.7900] },
                { name: "ÏùåÏãù Î™®Ìòï", pos: [35.7140, 139.7890] },
                { name: "Ïπ¥ÎßàÏïÑÏÇ¨ ÏÉÅÏ†ê", pos: [35.7130, 139.7895] }
            ],
            akihabara: [
                { name: "ÎùºÎîîÏò§ ÌöåÍ¥Ä", pos: [35.6980, 139.7720] },
                { name: "Í≤åÏù¥Î®∏Ï¶à Î≥∏Ï†ê", pos: [35.6982, 139.7725] },
                { name: "ÎßåÎã§ÎùºÏºÄ", pos: [35.7000, 139.7710] },
                { name: "Ïï†ÎãàÎ©îÏù¥Ìä∏", pos: [35.7005, 139.7715] },
                { name: "Ìä∏Î†àÏù¥Îçî Î≥∏Ï†ê", pos: [35.7010, 139.7718] },
                { name: "Ïä§Î£®Í∞ÄÏïº", pos: [35.6990, 139.7715] },
                { name: "HEY ÏïÑÏºÄÏù¥Îìú", pos: [35.6995, 139.7705] },
                { name: "GIGO 3Ìò∏Í¥Ä", pos: [35.6992, 139.7710] }
            ]
        };

        const RAW_DATA = [
            {
                day: 1,
                items: [
                    { time: "04:00 - 06:00", title: "Í∏∞ÏÉÅ Î∞è Í≥µÌï≠ Ï∂úÎ∞ú", loc: null, desc: "Ï∑®Ïπ® ÌõÑ Í∏∞ÏÉÅ" },
                    { time: "06:00 - 09:30", title: "Í≥µÌï≠ ÎèÑÏ∞© Î∞è ÎπÑÌñâ", loc: LOC.kix, desc: "ÌÉëÏäπ ÏàòÏÜç Î∞è ÎπÑÌñâ" },
                    { time: "09:30 - 09:43", title: "Í∞ÑÏÇ¨Ïù¥ Í≥µÌï≠ (Ìëú Íµ¨Îß§)", price: 980, loc: LOC.kix, desc: "ÎÇúÏπ¥Ïù¥ Í≥µÌï≠ÏÑ† Ìã∞ÏºìÌåÖ" },
                    { time: "10:34 - 10:50", title: "ÎÇúÎ∞îÏó≠ ÎèÑÏ∞© (Ïßê Î≥¥Í¥Ä)", loc: LOC.nambaStn, desc: "ÏàôÏÜå Ïù¥Îèô Ï†Ñ Ï§ÄÎπÑ" },
                    { time: "10:50 - 11:05", title: "ÏàôÏÜå Ïù¥Îèô", loc: LOC.osakaHotel, desc: "ÏÑ∏Î∏êÏùºÎ†àÎ∏ê Ïò§ÏÇ¨Ïπ¥ Î™®ÌÜ†ÎßàÏπò" },
                    { time: "11:05 - 12:25", title: "Ï†êÏã¨: ÌÖêÎèô ÎßàÌÇ§ÎÖ∏", price: 2400, loc: LOC.tendonMakino, desc: "Ïõ®Ïù¥ÌåÖ Î∞è Î∂ïÏû•Ïñ¥ ÌÖêÎèô" },
                    { time: "12:40 - 14:45", title: "Îç¥Îç¥ÌÉÄÏö¥ ÎçïÏßà Ìà¨Ïñ¥", loc: LOC.dendenTown, pois: POIS.denden, desc: "ÌÇ§Ï¶àÎûúÎìú, Ï†ïÍ∏Ä, Ïò§ÌÉÄÎ°úÎìú" },
                    { time: "14:45 - 15:00", title: "ÎÇúÎ∞îÏó≠ Î≥µÍ∑Ä", loc: LOC.nambaStn, desc: "ÌõÑÎ∞úÎåÄ Ìï©Î•ò" },
                    { time: "15:15 - 16:15", title: "Í∏ÄÎ¶¨ÏΩîÏÉÅ & ÎèÑÌÜ§Î≥¥Î¶¨", loc: LOC.glicoMan, desc: "Î©îÏù∏ Ìè¨ÌÜ†Ï°¥" },
                    { time: "16:15 - 16:45", title: "ÎßõÏßë Í∞ÑÌåê Ìà¨Ïñ¥", loc: LOC.dotonbori, pois: POIS.dotonbori_views, desc: "Ïπ¥ÎãàÎèÑÎùºÏø†, ÌÇ®Î•ò Îì±" },
                    { time: "16:45 - 17:45", title: "Íµ¨Î°úÎ™¨ ÏãúÏû•", loc: LOC.kuromon, pois: POIS.kuromon, price: 1500, desc: "Ï∞∏Ïπò, Í∞ÄÎ¶¨ÎπÑ, ÌôîÏù¥Ìä∏ Îî∏Í∏∞" },
                    { time: "18:00 - 19:30", title: "Ï†ÄÎÖÅ: ÏïÑÎ∂ÄÎ¶¨Ïïº", price: 4900, loc: LOC.aburiya, desc: "ÏïºÌÇ§ÎãàÏø† Î¨¥ÌïúÎ¶¨ÌïÑ" },
                    { time: "19:30 - 21:00", title: "ÎèÑÌÜ§Î≥¥Î¶¨ ÏïºÍ≤Ω", loc: LOC.dotonbori, price: 1000, desc: "Í∞ÑÏãù Î∞è ÏÇ∞Ï±Ö" },
                    { time: "21:00 - 22:00", title: "ÏïºÏãù: Ïä§ÎØ∏ÎπÑÏïºÌÇ§ÌÜ†Î¶¨ÌÜ†", price: 2000, loc: LOC.sumibi, desc: "Íº¨ÏπòÍµ¨Ïù¥" },
                    { time: "22:15", title: "ÏàôÏÜå Î≥µÍ∑Ä", loc: LOC.osakaHotel }
                ]
            },
            {
                day: 2,
                items: [
                    { time: "05:00 - 06:00", title: "Í∏∞ÏÉÅ Î∞è Ï§ÄÎπÑ", loc: LOC.osakaHotel, desc: "USJ Ïò§ÌîàÎü∞ Ï§ÄÎπÑ" },
                    { time: "06:15", title: "ÎÇúÎ∞îÏó≠ Ï∂úÎ∞ú", loc: LOC.nambaStn, desc: "ÌïúÏã†ÏÑ† ÌÉëÏäπ" },
                    { time: "07:15 - 19:30", title: "USJ Ïú†ÎãàÎ≤ÑÏÑ§ Ïä§ÌäúÎîîÏò§", loc: LOC.usj, pois: POIS.usj, price: 11000, desc: "ÎãåÌÖêÎèÑ, Ìï¥Î¶¨Ìè¨ÌÑ∞, ÎØ∏ÎãàÏñ∏ Îì± ÌíÄÏΩîÏä§" },
                    { time: "20:30 - 22:00", title: "Ï†ÄÎÖÅ: ÌõÑÏø†ÌÉÄÎ°ú Î≥∏Ï†ê", loc: LOC.fukutaro, price: 2500, desc: "Ïò§ÏΩîÎÖ∏ÎØ∏ÏïºÌÇ§ ÎßõÏßë (Ïõ®Ïù¥ÌåÖ Ï£ºÏùò)" },
                    { time: "22:30", title: "ÏàôÏÜå Î≥µÍ∑Ä", loc: LOC.osakaHotel }
                ]
            },
            {
                day: 3,
                items: [
                    { time: "06:00 - 07:00", title: "Í∏∞ÏÉÅ Î∞è ÏïÑÏπ®ÏãùÏÇ¨", loc: LOC.nambaStn, price: 780, desc: "Ïã†ÌååÏπò ÏãùÎãπ Îì±" },
                    { time: "08:45 - 10:15", title: "ÌõÑÏãúÎØ∏ Ïù¥ÎÇòÎ¶¨ Ïã†ÏÇ¨", loc: LOC.fushimiInari, pois: POIS.fushimi, desc: "Ï≤úÍ∞úÏùò ÌÜ†Î¶¨Ïù¥, Ïò§Ïø†ÏÉ§ Î¥âÎ∞∞ÏÜå" },
                    { time: "10:15 - 12:30", title: "Ï†êÏã¨: ÏïºÎßàÎ™®ÌÜ† Î©òÏ°∞Ïö∞", loc: LOC.yamamoto, price: 1200, desc: "Ïö∞Îèô ÎßõÏßë (ÏòàÏïΩÌïÑÏàò)" },
                    { time: "13:00 - 14:30", title: "Í∏∞ÏöîÎØ∏Ï¶àÌÖåÎùº (Ï≤≠ÏàòÏÇ¨)", loc: LOC.kiyomizu, pois: POIS.kiyomizu, price: 400, desc: "Î≥∏Îãπ Î¨¥ÎåÄ, Ïò§ÌÜ†ÏôÄ Ìè≠Ìè¨" },
                    { time: "14:30 - 15:30", title: "ÏÇ∞ÎÑ®ÏûêÏπ¥ & ÎãàÎÑ®ÏûêÏπ¥", loc: LOC.sannenzaka, pois: POIS.sannenzaka, desc: "Ïä§ÌÉÄÎ≤ÖÏä§ Îã§Îã§ÎØ∏, ÎèôÍµ¨Î¶¨ Í≥µÌôîÍµ≠ Îì±" },
                    { time: "16:00 - 16:50", title: "Í∞ÄÎ™®Í∞ï Ïπ¥Ìéò ÌîºÌÅ¨Îãâ", loc: LOC.kamoRiver, pois: POIS.kamo_cafes, price: 700, desc: "Ïä§ÌÉÄÎ≤ÖÏä§/Î∏îÎ£®Î≥¥ÌãÄ ÌÖåÏù¥ÌÅ¨ÏïÑÏõÉ, Í∞ïÎ≥Ä Ìú¥Ïãù" },
                    { time: "16:50 - 18:00", title: "Ï†ÄÎÖÅ1: ÏøÑ Î™®Ï∏†ÎÇòÎ≤†", loc: LOC.hideatora, price: 3500, desc: "ÌûàÎç∞ÌÜ†Îùº Î∞±ÎêúÏû• ÎÇòÎ≤†" },
                    { time: "18:00 - 19:30", title: "Í∏∞Ïò® & Ìè∞ÌÜ†Ï¥à Í±∞Î¶¨", loc: LOC.gion, pois: [...POIS.gion, ...POIS.pontocho], desc: "ÌïòÎÇòÎØ∏ÏΩîÏßÄ, ÏïºÏÇ¨Ïπ¥Ïã†ÏÇ¨, Ìè∞ÌÜ†Ï¥à Í≥®Î™©" },
                    { time: "19:30 - 20:30", title: "Ï†ÄÎÖÅ2: Ìè∞ÌÜ†Ïµ∏ ÏïºÏÜåÌïòÏπò", loc: LOC.yasohachi, price: 3000, desc: "ÍµêÌÜ† Î∂ÑÏúÑÍ∏∞ Ïù¥ÏûêÏπ¥Ïïº" },
                    { time: "22:00", title: "Ïò§ÏÇ¨Ïπ¥ Î≥µÍ∑Ä", loc: LOC.osakaHotel, price: 2000, desc: "ÎùºÏö¥ÎìúÏõê Îì± ÏÑ†ÌÉù" }
                ]
            },
            {
                day: 4,
                items: [
                    { time: "09:00 - 10:20", title: "Í∏∞ÏÉÅ Î∞è ÏïÑÏπ®(ÏΩîÎ©îÎã§)", loc: LOC.nambaStn, price: 800, desc: "Î™®Îãù ÏÑ∏Ìä∏" },
                    { time: "10:20", title: "Ïã†Ïò§ÏÇ¨Ïπ¥Ïó≠ Ïù¥Îèô", loc: LOC.shinOsaka, price: 230 },
                    { time: "13:33", title: "ÎèÑÏøÑÏó≠ ÎèÑÏ∞© (Ïã†Ïπ∏ÏÑº)", loc: LOC.tokyoStn, price: 14500, desc: "ÏóêÌÇ§Î≤§ Ï†êÏã¨" },
                    { time: "14:00", title: "Ïö∞ÏóêÎÖ∏ ÏàôÏÜå (Ïßê)", loc: LOC.uenoHotel, desc: "Ï≤¥ÌÅ¨Ïù∏/Î≥¥Í¥Ä" },
                    { time: "14:20 - 15:20", title: "Í∞ìÌååÎ∞îÏãú ÎèÑÍµ¨Í±∞Î¶¨", loc: LOC.kappabashi, pois: POIS.kappabashi, desc: "ÏöîÎ¶¨ ÎèÑÍµ¨ ÏáºÌïë" },
                    { time: "15:40 - 17:00", title: "ÏÑºÏÜåÏßÄ & ÎÇòÏπ¥ÎØ∏ÏÑ∏ÎèÑÎ¶¨", loc: LOC.sensoji, pois: POIS.sensoji, desc: "Ïπ¥ÎØ∏ÎÇòÎ¶¨Î™¨, Î©òÏπòÏπ¥Ï∏†, Î©îÎ°†Îπµ Îì±" },
                    { time: "17:30 - 18:30", title: "ÏïÑÌÇ§ÌïòÎ∞îÎùº ÌÉêÎ∞©", loc: LOC.akihabara, pois: POIS.akihabara, desc: "ÎùºÎîîÏò§ÌöåÍ¥Ä, ÎßåÎã§ÎùºÏºÄ, Ìä∏Î†àÏù¥Îçî" },
                    
                    // SPLIT DINNER
                    { 
                        time: "18:30 - 19:30", 
                        title: "Ï†ÄÎÖÅ: ÎùºÎ©ò (ÌåÄ Î∂ÑÎ¶¨)", 
                        type: "split_dinner",
                        routes: [
                            { name: "AÌåÄ: Î©òÎèÑÏΩîÎ°ú ÌòºÎã§", to: LOC.honda, color: "#ef4444", desc: "ÏáºÏú† ÎùºÎ©ò" },
                            { name: "BÌåÄ: Ìò∏ÌÉÄÌÖå ÎπÑÏöîÎ¶¨", to: LOC.hotate, color: "#22c55e", desc: "Í∞ÄÎ¶¨ÎπÑ ÎùºÎ©ò" }
                        ],
                        price: 1300,
                        desc: "Í∞ÅÏûê Ïõ®Ïù¥ÌåÖ ÌõÑ ÏãùÏÇ¨"
                    },

                    { 
                        time: "19:30 - 20:30", 
                        title: "GIGO & Í∞ÄÏ±†Ìè∞", 
                        loc: LOC.gigo,
                        type: "merge", 
                        froms: [LOC.honda, LOC.hotate], 
                        desc: "Îã§Ïãú Ìï©Î•òÌïòÏó¨ Í≤åÏûÑ Î∞è Í∞ÄÏ±†",
                        price: 2000
                    },
                    { time: "20:30 - 21:00", title: "ÏïÑÎ©îÏöîÏΩî ÏãúÏû•", loc: LOC.ameyoko, pois: POIS.ameyoko, desc: "ÎãàÌÇ§Ïùò Í≥ºÏûê, Î©òÏπòÏπ¥Ï∏† Îì± Íµ¨Í≤Ω" },
                    { time: "21:00", title: "Ïù¥ÏûêÏπ¥Ïïº Îí∑ÌíÄÏù¥", loc: LOC.ameyoko, price: 3500, desc: "Ïó¨Ìñâ ÎßàÎ¨¥Î¶¨" }
                ]
            }
        ];

        // --- 2. LOGIC ---
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function preprocessSchedule(rawData) {
            const processed = [];
            rawData.forEach(day => {
                const newItems = [];
                for(let i = 0; i < day.items.length; i++) {
                    const curr = day.items[i];
                    const currLoc = curr.loc || (curr.type === 'split_dinner' ? LOC.akihabara : null);
                    
                    newItems.push({ ...curr, type: curr.type || 'stay' });

                    if (i < day.items.length - 1) {
                        const next = day.items[i+1];
                        const nextLoc = next.loc || (next.type === 'split_dinner' ? LOC.akihabara : null);
                        
                        if (currLoc && nextLoc && next.type !== 'merge') { 
                            const dist = getDistance(currLoc[0], currLoc[1], nextLoc[0], nextLoc[1]);
                            if (dist > 0.15) { 
                                const isTrain = dist > 1.8;
                                // Parse departure time from current item's end time
                                const endTime = curr.time ? curr.time.split(' - ')[1] : "";
                                const departureText = endTime ? `${endTime} Ï∂úÎ∞ú` : "Ïù¥Îèô";

                                newItems.push({
                                    title: departureText,
                                    type: 'move',
                                    transport: isTrain ? 'train' : 'walk',
                                    from: currLoc,
                                    to: nextLoc,
                                    price: isTrain ? 170 : 0,
                                    dist: dist.toFixed(1),
                                    time: "",
                                    desc: isTrain ? `Ï†ÑÏ≤†/Î≤ÑÏä§ Í∂åÏû• (${dist.toFixed(1)}km)` : `ÎèÑÎ≥¥ Ïù¥Îèô (${dist.toFixed(1)}km)`
                                });
                            }
                        }
                    }
                }
                processed.push({ day: day.day, items: newItems });
            });
            return processed;
        }

        const SCHEDULE = preprocessSchedule(RAW_DATA);

        // --- 3. MAP ---
        const map = L.map('map', { zoomControl: false }).setView([34.6618, 135.5021], 13);
        L.control.zoom({ position: 'topright' }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO', maxZoom: 19
        }).addTo(map);

        let layers = [];
        const icons = {
            start: L.divIcon({ html: '<div class="bg-indigo-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold shadow-lg border-2 border-white">S</div>', className: 'bg-transparent', iconSize: [32, 32], iconAnchor: [16, 32] }),
            end: L.divIcon({ html: '<div class="bg-slate-700 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold shadow-lg border-2 border-white">E</div>', className: 'bg-transparent', iconSize: [32, 32], iconAnchor: [16, 32] }),
            poi: L.divIcon({ className: 'pulse-icon' }),
            poiBlue: L.divIcon({ className: 'pulse-icon-blue' }),
            splitA: L.divIcon({ html: '<div class="bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold border-2 border-white">A</div>', className: 'bg-transparent', iconSize: [24,24] }),
            splitB: L.divIcon({ html: '<div class="bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold border-2 border-white">B</div>', className: 'bg-transparent', iconSize: [24,24] })
        };

        async function drawRoute(from, to, color = '#3b82f6') {
            const dashed = L.polyline([from, to], { color: '#cbd5e1', weight: 4, dashArray: '8, 8', opacity: 0.8 }).addTo(map);
            layers.push(dashed);
            
            try {
                const resp = await fetch(`https://router.project-osrm.org/route/v1/foot/${from[1]},${from[0]};${to[1]},${to[0]}?overview=full&geometries=geojson`);
                const data = await resp.json();
                if(data.code === 'Ok') {
                    const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                    map.removeLayer(dashed);
                    const route = L.polyline(coords, { color: color, weight: 5, opacity: 0.8, lineJoin: 'round' }).addTo(map);
                    layers.push(route);
                    map.fitBounds(route.getBounds(), { padding: [50, 50] });
                }
            } catch(e) {}
        }

        // --- 4. TOGGLE UI FUNCTIONS ---
        function toggleInfo() {
            const content = document.getElementById('info-content');
            const icon = document.getElementById('toggle-icon');
            const isCollapsed = content.classList.contains('collapsed-content');
            
            if(isCollapsed) {
                // Expand
                content.classList.remove('collapsed-content');
                icon.classList.remove('rotate-180');
            } else {
                // Collapse
                content.classList.add('collapsed-content');
                icon.classList.add('rotate-180');
            }
        }

        function closeInfo() {
            document.getElementById('map-info').classList.add('hidden', 'opacity-0', 'translate-y-[-20px]');
        }

        // --- 5. RENDER ---
        function formatMoney(n) { return n ? `¬•${n.toLocaleString()}` : ''; }

        function renderTimeline(dayIdx) {
            const list = document.getElementById('schedule-list');
            const dayData = SCHEDULE[dayIdx];
            list.innerHTML = '';
            
            document.getElementById('split-legend').classList.toggle('hidden', dayIdx !== 3);
            let total = 0; dayData.items.forEach(i => total += (i.price||0));
            document.getElementById('total-cost-desktop').innerText = `Ï¥ù ÏòàÏÉÅ ÎπÑÏö©: ${formatMoney(total)}`;
            document.getElementById('total-cost-mobile').innerText = `Total: ${formatMoney(total)}`;

            dayData.items.forEach((item) => {
                const isMove = item.type === 'move';
                const isSplit = item.type === 'split_dinner';
                
                const card = document.createElement('div');
                card.className = `schedule-item p-3 md:p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer relative bg-white my-2 ${isMove ? 'bg-slate-50 border-dashed opacity-80' : ''}`;
                
                // Icon Construction
                let iconEl = `<div class="w-10 h-10 rounded-full bg-indigo-50 text-indigo-500 flex items-center justify-center"><i class="fas fa-map-pin"></i></div>`;
                if(item.title.includes('Í∏∞ÏÉÅ')) iconEl = `<div class="w-10 h-10 rounded-full bg-yellow-50 text-yellow-500 flex items-center justify-center"><i class="fas fa-sun"></i></div>`;
                else if(isMove) iconEl = `<div class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center"><i class="fas fa-${item.transport === 'train' ? 'train' : 'person-walking'}"></i></div>`;
                else if(item.title.includes('ÏãùÏÇ¨') || item.title.includes('Ï†ÄÎÖÅ')) iconEl = `<div class="w-10 h-10 rounded-full bg-orange-50 text-orange-500 flex items-center justify-center"><i class="fas fa-utensils"></i></div>`;
                else if(isSplit) iconEl = `<div class="w-10 h-10 rounded-full bg-pink-50 text-pink-500 flex items-center justify-center"><i class="fas fa-code-branch"></i></div>`;

                let timeStr = item.time ? item.time.split(' - ')[0] : '';
                // If it's a move item, show Departure time clearly
                if (isMove && item.title.includes('Ï∂úÎ∞ú')) timeStr = item.title.split(' ')[0];

                let content = `<div class="flex items-center gap-3">`;
                content += `<div class="flex flex-col items-center gap-1 min-w-[50px]"><span class="text-[10px] font-bold text-gray-500">${timeStr}</span>${iconEl}</div>`;
                content += `<div class="flex-1 min-w-0"><div class="flex justify-between items-start"><h4 class="font-bold text-gray-800 truncate ${isMove ? 'text-sm text-gray-500' : ''}">${item.title}</h4>`;
                if(item.price) content += `<span class="text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded font-bold ml-1 shrink-0">${formatMoney(item.price)}</span>`;
                content += `</div>`;
                
                if(item.desc) content += `<p class="text-xs text-gray-500 mt-1 truncate">${item.desc}</p>`;
                if(isMove && item.dist) content += `<p class="text-[10px] text-blue-500 font-semibold mt-0.5"><i class="fas fa-route"></i> ${item.dist}km Ïù¥Îèô</p>`;
                
                if(isSplit) content += `<div class="flex gap-2 mt-2"><span class="text-[10px] px-2 py-1 rounded border split-badge-a flex-1 text-center">A: ÌòºÎã§</span><span class="text-[10px] px-2 py-1 rounded border split-badge-b flex-1 text-center">B: Ìò∏ÌÉÄÌÖå</span></div>`;
                content += `</div></div>`;
                card.innerHTML = content;

                card.onclick = () => {
                    document.querySelectorAll('.schedule-item').forEach(e => e.classList.remove('active-card'));
                    card.classList.add('active-card');
                    layers.forEach(l => map.removeLayer(l)); layers = [];
                    
                    // Show & Reset Info Box State
                    const infoBox = document.getElementById('map-info');
                    const infoContent = document.getElementById('info-content');
                    const toggleIcon = document.getElementById('toggle-icon');
                    
                    infoBox.classList.remove('hidden', 'opacity-0', 'translate-y-[-20px]');
                    // Ensure it is open when clicked
                    infoContent.classList.remove('collapsed-content');
                    toggleIcon.classList.remove('rotate-180');

                    document.getElementById('info-title').innerText = item.title;
                    
                    let infoHtml = `<p class="mb-2">${item.desc || ''}</p>`;

                    // Visualization Logic
                    if (isSplit) {
                        const start = LOC.akihabara;
                        item.routes.forEach(r => {
                            drawRoute(start, r.to, r.color);
                            layers.push(L.marker(r.to, {icon: r.name.includes('A')?icons.splitA:icons.splitB}).addTo(map).bindPopup(r.name));
                        });
                        layers.push(L.marker(start, {icon: icons.start}).addTo(map));
                    } else if (item.type === 'merge') {
                        item.froms.forEach((f, idx) => {
                            drawRoute(f, item.loc, idx===0?'#ef4444':'#22c55e');
                            layers.push(L.marker(f, {icon: idx===0?icons.splitA:icons.splitB}).addTo(map));
                        });
                        layers.push(L.marker(item.loc, {icon: icons.end}).addTo(map).bindPopup("GIGO ÏßëÍ≤∞"));
                    } else if (isMove) {
                        drawRoute(item.from, item.to, item.transport==='train'?'#8b5cf6':'#3b82f6');
                        layers.push(L.marker(item.from, {icon: icons.start}).addTo(map));
                        layers.push(L.marker(item.to, {icon: icons.end}).addTo(map));
                    } else {
                        if(item.loc) {
                            map.setView(item.loc, 15);
                            layers.push(L.marker(item.loc, {icon: icons.start}).addTo(map));
                        }
                        if(item.pois) {
                            const bounds = L.latLngBounds(item.pois.map(p => p.pos));
                            item.pois.forEach(p => {
                                layers.push(L.marker(p.pos, {icon: icons.poi}).addTo(map).bindTooltip(p.name, {permanent:true, direction:'top', className:'text-xs font-bold bg-white border px-1 rounded shadow'}));
                            });
                            map.fitBounds(bounds, {padding:[50,50]});
                            
                            // Generate POI list in Info Box
                            infoHtml += `<div class="grid grid-cols-2 gap-1 mt-2">`;
                            item.pois.forEach(p => infoHtml += `<span class="text-xs bg-gray-50 px-2 py-1 rounded border">üìç ${p.name}</span>`);
                            infoHtml += `</div>`;
                        }
                    }
                    document.getElementById('info-content').innerHTML = infoHtml;
                };
                list.appendChild(card);
            });
        }

        function selectDay(idx) {
            [0,1,2,3].forEach(i => {
                const btn = document.getElementById(`tab-${i}`);
                if(i===idx) { btn.classList.add('text-indigo-600','border-indigo-600'); btn.classList.remove('text-gray-500'); }
                else { btn.classList.remove('text-indigo-600','border-indigo-600'); btn.classList.add('text-gray-500'); }
            });
            layers.forEach(l => map.removeLayer(l)); layers = [];
            document.getElementById('map-info').classList.add('hidden');
            renderTimeline(idx);
            
            const first = SCHEDULE[idx].items.find(i => i.loc);
            if(first) map.setView(first.loc, 13);
        }

        selectDay(0);
    </script>
</body>
</html>

