<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ë³¸ ì—¬í–‰ ì¼ì • (Multi-Select Route)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; }
        #map { height: 100%; width: 100%; z-index: 0; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* Marker Animations */
        .pulse-icon {
            background-color: #ef4444; border-radius: 50%; width: 12px; height: 12px;
            box-shadow: 0 0 0 rgba(239, 68, 68, 0.4); animation: pulse 2s infinite;
        }
        .pulse-icon-blue {
            background-color: #3b82f6; border-radius: 50%; width: 12px; height: 12px;
            box-shadow: 0 0 0 rgba(59, 130, 246, 0.4); animation: pulse-blue 2s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        .schedule-item { transition: all 0.2s; border-left: 3px solid transparent; user-select: none; }
        .schedule-item:hover { transform: translateX(4px); border-left-color: #cbd5e1; }
        
        /* Active & Selected States */
        .active-card { border-left-color: #3b82f6 !important; background-color: #eff6ff !important; }
        .multi-selected { 
            background-color: #dbeafe !important; 
            border-left-color: #2563eb !important;
            border: 1px solid #93c5fd !important;
        }
        
        .split-badge-a { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .split-badge-b { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        
        /* Custom Popup */
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 280px !important; }

        /* Collapse Animation */
        #info-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding 0.3s;
            overflow: hidden;
        }
        .collapsed-content {
            max-height: 0 !important;
            opacity: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }
        .rotate-180 { transform: rotate(180deg); }

        /* Numbered Marker for Route */
        .number-icon {
            background: #2563eb; color: white; border-radius: 50%;
            text-align: center; line-height: 24px; font-weight: bold;
            font-size: 14px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col md:flex-row overflow-hidden">

    <div class="md:hidden bg-indigo-600 text-white p-3 shadow-md z-20 flex justify-between items-center shrink-0">
        <h1 class="font-bold text-lg">ğŸ‡¯ğŸ‡µ 3ë°• 4ì¼ ì¼ì •í‘œ</h1>
        <span id="total-cost-mobile" class="text-xs bg-indigo-700 px-2 py-1 rounded font-mono"></span>
    </div>

    <div class="w-full md:w-1/3 flex flex-col h-1/2 md:h-full bg-white shadow-xl z-10 relative">
        <div class="hidden md:block p-5 bg-indigo-600 text-white shadow-md shrink-0">
            <h1 class="text-2xl font-bold">ğŸ‡¯ğŸ‡µ Japan Travel</h1>
            <p class="text-indigo-100 text-sm mt-1">ì˜¤ì‚¬ì¹´ â€¢ êµí†  â€¢ ë„ì¿„ (1ì¼ì°¨ ~ 4ì¼ì°¨)</p>
            <div class="mt-3 flex justify-between items-center">
                <div id="total-cost-desktop" class="bg-indigo-800 px-3 py-1 rounded-full text-xs font-mono font-bold tracking-wide"></div>
                <button onclick="clearSelection()" id="btn-reset-select" class="hidden text-xs bg-white text-indigo-600 px-2 py-1 rounded font-bold hover:bg-gray-100">ì„ íƒ ì´ˆê¸°í™”</button>
            </div>
        </div>

        <div class="flex overflow-x-auto bg-white border-b shrink-0">
            <button onclick="selectDay(0)" id="tab-0" class="flex-1 py-3 text-center border-b-2 text-sm font-semibold text-gray-500 hover:text-indigo-600">1ì¼ì°¨<br><span class="text-xs font-normal">ì˜¤ì‚¬ì¹´</span></button>
            <button onclick="selectDay(1)" id="tab-1" class="flex-1 py-3 text-center border-b-2 text-sm font-semibold text-gray-500 hover:text-indigo-600">2ì¼ì°¨<br><span class="text-xs font-normal">USJ</span></button>
            <button onclick="selectDay(2)" id="tab-2" class="flex-1 py-3 text-center border-b-2 text-sm font-semibold text-gray-500 hover:text-indigo-600">3ì¼ì°¨<br><span class="text-xs font-normal">êµí† </span></button>
            <button onclick="selectDay(3)" id="tab-3" class="flex-1 py-3 text-center border-b-2 text-sm font-semibold text-gray-500 hover:text-indigo-600">4ì¼ì°¨<br><span class="text-xs font-normal">ë„ì¿„</span></button>
        </div>

        <div id="schedule-list" class="flex-1 overflow-y-auto p-2 md:p-4 space-y-3 bg-slate-50 pb-20 md:pb-5"></div>
        
        <div id="multi-select-hint" class="absolute bottom-2 left-0 w-full text-center pointer-events-none transition-opacity duration-500 opacity-100">
            <span class="bg-gray-800 text-white text-xs px-3 py-1.5 rounded-full shadow-lg opacity-80">ğŸ’¡ ê¸¸ê²Œ ëˆŒëŸ¬ ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥</span>
        </div>

        <div id="split-legend" class="absolute bottom-0 w-full bg-white border-t p-2 text-xs flex justify-around hidden shadow-[0_-5px_15px_rgba(0,0,0,0.1)]">
            <div class="flex items-center gap-1"><span class="w-3 h-3 bg-red-500 rounded-full"></span> <span>AíŒ€: ë©˜ë„ì½”ë¡œ í˜¼ë‹¤</span></div>
            <div class="flex items-center gap-1"><span class="w-3 h-3 bg-green-500 rounded-full"></span> <span>BíŒ€: í˜¸íƒ€í…Œ ë¹„ìš”ë¦¬</span></div>
        </div>
    </div>

    <div class="w-full md:w-2/3 h-1/2 md:h-full relative">
        <div id="map"></div>
        
        <div id="map-info" class="absolute top-5 right-5 bg-white rounded-xl shadow-2xl hidden md:flex flex-col z-[400] w-80 border border-gray-100 transition-all duration-300 opacity-0 translate-y-[-20px]">
            <div class="flex justify-between items-center p-4 bg-gray-50 border-b cursor-pointer rounded-t-xl" onclick="toggleInfo()">
                <h3 id="info-title" class="font-bold text-gray-800 truncate pr-2"></h3>
                <div class="flex gap-3 text-gray-400">
                    <button id="toggle-icon" class="hover:text-blue-500 transition-transform duration-300"><i class="fas fa-chevron-up"></i></button>
                    <button onclick="event.stopPropagation(); closeInfo()" class="hover:text-red-500 transition-colors"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="info-content" class="text-sm text-gray-600 space-y-2 max-h-[60vh] overflow-y-auto p-4 bg-white rounded-b-xl collapsed-content"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. DATA: Locations & Detailed POIs (Same as before) ---
        const LOC = {
            kix: [34.4325, 135.2304],
            nambaStn: [34.6618, 135.5021],
            osakaHotel: [34.6635, 135.4975], 
            tendonMakino: [34.6682, 135.5036],
            dendenTown: [34.6593, 135.5057],
            glicoMan: [34.6687, 135.5013],
            kuromon: [34.6654, 135.5074],
            aburiya: [34.6690, 135.5015],
            dotonbori: [34.6687, 135.5013],
            sumibi: [34.6675, 135.5000],
            usj: [34.6654, 135.4323],
            fukutaro: [34.6657, 135.5042],
            fushimiInari: [34.9671, 135.7726],
            yamamoto: [35.0157, 135.7825],
            kiyomizu: [34.9948, 135.7850],
            sannenzaka: [34.9960, 135.7820],
            kamoRiver: [35.0080, 135.7710],
            hideatora: [35.0050, 135.7700],
            pontocho: [35.0062, 135.7716],
            gion: [35.0035, 135.7750],
            yasohachi: [35.0055, 135.7710],
            roundOne: [34.6653, 135.5039],
            shinOsaka: [34.7334, 135.5003],
            tokyoStn: [35.6812, 139.7671],
            uenoHotel: [35.7122, 139.7758],
            kappabashi: [35.7153, 139.7895],
            sensoji: [35.7147, 139.7966],
            akihabara: [35.6983, 139.7730],
            ameyoko: [35.7088, 139.7741],
            honda: [35.6997, 139.7754], 
            hotate: [35.6963, 139.7856], 
            gigo: [35.6994, 139.7712] 
        };

        const POIS = {
            denden: [
                { name: "ì¡°ì‹  ìŠˆí¼ í‚¤ì¦ˆ ëœë“œ", pos: [34.6595, 135.5055] },
                { name: "ì •ê¸€ (Jungle)", pos: [34.6600, 135.5060] },
                { name: "ìŠˆí¼ í¬í…Œì´í† ", pos: [34.6610, 135.5058] },
                { name: "ì• ë‹ˆë©”ì´íŠ¸", pos: [34.6605, 135.5050] },
                { name: "ìŠ¤ë£¨ê°€ì•¼", pos: [34.6590, 135.5052] },
                { name: "ë¼ì‹ ë°˜", pos: [34.6598, 135.5056] },
                { name: "ì˜¤íƒ€ë¡œë“œ", pos: [34.6590, 135.5065] }
            ],
            dotonbori_views: [
                { name: "ê¸€ë¦¬ì½”ìƒ (ë©”ì¸)", pos: [34.6687, 135.5013] },
                { name: "ì¹´ë‹ˆë„ë¼ì¿  (ì›€ì§ì´ëŠ” ê²Œ)", pos: [34.6687, 135.5013] },
                { name: "í‚¨ë¥˜ ë¼ë©˜ (ìš© ê°„íŒ)", pos: [34.6685, 135.5030] },
                { name: "ê²ë¡œì¿  ìŠ¤ì‹œ (ê±°ëŒ€ ìŠ¤ì‹œ)", pos: [34.6682, 135.5010] },
                { name: "ì˜¤ì‚¬ì¹´ ì˜¤ì‡¼ (ê±°ëŒ€ êµì)", pos: [34.6686, 135.5020] },
                { name: "ì¿ ì¿ ë£¨ (ê±°ëŒ€ ë¬¸ì–´)", pos: [34.6688, 135.5015] }
            ],
            kuromon: [
                { name: "ë§ˆêµ¬ë¡œì•¼ ì¿ ë¡œê¸´ (ì°¸ì¹˜)", pos: [34.6655, 135.5075] },
                { name: "ë§ˆë£¨ì   ì‹ìœ¡ì  (ê³ ë² ê·œ)", pos: [34.6652, 135.5072] },
                { name: "ì´ì‹œë°”ì‹œ ì‹í’ˆ (ì˜¤ë…)", pos: [34.6656, 135.5077] },
                { name: "í™”ì´íŠ¸ ë”¸ê¸° & ë‘ìœ ", pos: [34.6650, 135.5076] },
                { name: "ìš°ì˜¤í›„ì¿  (ê°€ë¦¬ë¹„/ì„±ê²Œ)", pos: [34.6653, 135.5073] }
            ],
            usj: [
                { name: "ìŠˆí¼ ë‹Œí…ë„ ì›”ë“œ", pos: [34.6660, 135.4290] },
                { name: "ìœ„ì €ë”© ì›”ë“œ (í•´ë¦¬í¬í„°)", pos: [34.6640, 135.4280] },
                { name: "ë¯¸ë‹ˆì–¸ íŒŒí¬", pos: [34.6620, 135.4310] },
                { name: "ì¥¬ë¼ê¸° ê³µì›", pos: [34.6625, 135.4300] }
            ],
            fushimi: [
                { name: "ì„¼ë³¸ í† ë¦¬ì´", pos: [34.9665, 135.7750] },
                { name: "ì˜¤ì¿ ìƒ¤ ë´‰ë°°ì†Œ", pos: [34.9660, 135.7760] },
                { name: "ê³°ì˜ ìˆ² (ì¿ ë§ˆíƒ€ì¹´ìƒ¤)", pos: [34.9655, 135.7780] },
                { name: "ìš”ì¸ ì¸ ì§€", pos: [34.9650, 135.7800] }
            ],
            kiyomizu: [
                { name: "ë³¸ë‹¹ (ë¬´ëŒ€)", pos: [34.9948, 135.7850] },
                { name: "ì˜¤í† ì™€ í­í¬", pos: [34.9945, 135.7852] }
            ],
            sannenzaka: [
                { name: "ìŠ¤íƒ€ë²…ìŠ¤ (ë‹¤ë‹¤ë¯¸)", pos: [34.9985, 135.7805] },
                { name: "ë™êµ¬ë¦¬ ê³µí™”êµ­", pos: [34.9965, 135.7815] },
                { name: "ë§ˆë¥´ë¸”ë‘ìŠˆ (ì°¨ë…¸ì¹´)", pos: [34.9958, 135.7825] },
                { name: "ìš”ì§€ì•¼", pos: [34.9962, 135.7818] },
                { name: "ì‹œì¹˜ë¯¸ì•¼ í˜¼í¬", pos: [34.9955, 135.7828] },
                { name: "ì´ë…¸ë‹¤ ì»¤í”¼", pos: [34.9960, 135.7810] },
                { name: "ì˜¤ì¹´ë£¨ (ì¹´ë ˆìš°ë™)", pos: [35.0038, 135.7745] } 
            ],
            kamo_cafes: [
                { name: "ìŠ¤íƒ€ë²…ìŠ¤ ì‚°ì¡°ì˜¤í•˜ì‹œ", pos: [35.0090, 135.7718] },
                { name: "ì¹´ì™€ ì¹´í˜ (Kawa)", pos: [35.0015, 135.7705] },
                { name: "ì‚´ë¡± ë“œ ë¡œì–„", pos: [35.0110, 135.7715] },
                { name: ".S (ë‹· ì—ìŠ¤)", pos: [35.0130, 135.7725] },
                { name: "ì™€ì´í”„ ì•¤ í—ˆì¦ˆë²ˆë“œ", pos: [35.0450, 135.7590] }
            ],
            gion: [
                { name: "í•˜ë‚˜ë¯¸ì½”ì§€ (ë©”ì¸)", pos: [35.0035, 135.7750] },
                { name: "ì•¼ì‚¬ì¹´ ì‹ ì‚¬", pos: [35.0036, 135.7785] },
                { name: "ê¸°ì˜¨ ì¸ ì§€ë¦¬ (íŒŒë¥´í˜)", pos: [35.0038, 135.7742] },
                { name: "ì¹´ê¸°ì   ìš”ì‹œí›„ì‚¬", pos: [35.0039, 135.7748] },
                { name: "ê¸°ì˜¨ í‚¤ë‚˜ë‚˜", pos: [35.0025, 135.7755] },
                { name: "íƒ€ì¸ ë¯¸ ë‹¤ë¦¬", pos: [35.0055, 135.7735] },
                { name: "ë¯¸ë‚˜ë¯¸ì¢Œ (ê·¹ì¥)", pos: [35.0040, 135.7725] }
            ],
            pontocho: [
                { name: "í°í† ì´ˆ ê³¨ëª©", pos: [35.0062, 135.7716] },
                { name: "ìœ ì¦ˆê² (ìœ ìë‚˜ë² )", pos: [35.0058, 135.7715] },
                { name: "ëª¨ì¸ ë‚˜ë²  í† ë¼ì•¼", pos: [35.0060, 135.7715] },
                { name: "êµí†  ì•¼í‚¤ë‹ˆì¿  ì—”ì—”", pos: [35.0045, 135.7712] },
                { name: "ê°“íŒŒ ìŠ¤ì‹œ", pos: [35.0050, 135.7713] }
            ],
            sensoji: [
                { name: "ì¹´ë¯¸ë‚˜ë¦¬ëª¬ (ì œë“±)", pos: [35.7111, 139.7964] },
                { name: "í˜¸ì¡°ëª¬", pos: [35.7138, 139.7966] },
                { name: "ë³¸ë‹¹ (ê´€ìŒë‹¹)", pos: [35.7147, 139.7966] },
                { name: "ì•„ì‚¬ì¿ ì‚¬ ë°€ë ˆ ë©”ë ˆ (ì• í”ŒíŒŒì´)", pos: [35.7118, 139.7963] },
                { name: "ì•„ì‚¬ì¿ ì‚¬ ì‹ ì‚¬", pos: [35.7150, 139.7972] },
                { name: "ì˜¤ë¯¸ì¿ ì§€ êµ¬ì—­", pos: [35.7144, 139.7962] },
                { name: "í‚¤ë¬´ë¼ì•¼ (ì¸í˜•ë¹µ)", pos: [35.7140, 139.7965] },
                { name: "í‚¤ë¹„ë‹¹ê³  ì•„ì¦ˆë§ˆ", pos: [35.7125, 139.7965] },
                { name: "ì•„ì‚¬ì¿ ì‚¬ ì½”ì½”ë…¸ì—", pos: [35.7141, 139.7965] },
                { name: "í™”ì›”ë‹¹ (ë©”ë¡ ë¹µ)", pos: [35.7135, 139.7950] },
                { name: "ì‹¤í¬ í‘¸ë”©", pos: [35.7118, 139.7968] },
                { name: "í›„ë‚˜ì™€ (ì–‘ê°±)", pos: [35.7120, 139.7964] }
            ],
            ameyoko: [
                { name: "ì‹œë¬´ë¼ ì‡¼í… (ì´ˆì½œë¦¿)", pos: [35.7095, 139.7745] },
                { name: "ë‹ˆì¿ ë…¸ ì˜¤ì˜¤ì•¼ë§ˆ", pos: [35.7100, 139.7742] },
                { name: "ë¯¸ë‚˜í† ì•¼ (ë®ë°¥)", pos: [35.7092, 139.7743] },
                { name: "ë‹¤ì´í† ë¥˜ (ì´ìì¹´ì•¼)", pos: [35.7098, 139.7744] },
                { name: "ì•¼í‚¤í† ë¦¬ ë¶„ë¼ì¿ ", pos: [35.7097, 139.7744] },
                { name: "í–ì¹´ì—” (ê³¼ì¼)", pos: [35.7090, 139.7742] },
                { name: "ABCë§ˆíŠ¸ ë³¸ì ", pos: [35.7088, 139.7745] },
                { name: "ë‹ˆí‚¤ì˜ ê³¼ì", pos: [35.7085, 139.7743] }
            ],
            kappabashi: [
                { name: "ë‹ˆì´ë¯¸ ì‹ê¸° (ìš”ë¦¬ì‚¬ ë™ìƒ)", pos: [35.7100, 139.7900] },
                { name: "ê°„ì†Œ ì‡¼ì¿ íŒ (ìŒì‹ëª¨í˜•)", pos: [35.7140, 139.7890] },
                { name: "ì¹´ë§ˆì•„ì‚¬ ìƒì  (ì¹¼/ë¬´ì‡ )", pos: [35.7130, 139.7895] },
                { name: "ë§ˆì§€ë§ˆì•¼ (ì¿ í‚¤ í‹€ íƒ€ì›Œ)", pos: [35.7135, 139.7896] },
                { name: "ìœ ë‹ˆì˜¨ (ì»¤í”¼ ìš©í’ˆ)", pos: [35.7115, 139.7898] },
                { name: "ì´ì´ë‹¤ì•¼ (ì¡°ë¦¬ ë„êµ¬)", pos: [35.7125, 139.7892] },
                { name: "ì¸ ë°”ì•¼ (ì¹¼ ì „ë¬¸)", pos: [35.7118, 139.7893] },
                { name: "ë´ê°€ë§ˆ (ì¼ë³¸ ê·¸ë¦‡)", pos: [35.7120, 139.7894] }
            ],
            akihabara: [
                { name: "ë¼ë””ì˜¤ íšŒê´€", pos: [35.6980, 139.7720] },
                { name: "ê²Œì´ë¨¸ì¦ˆ ë³¸ì ", pos: [35.6982, 139.7725] },
                { name: "ë§Œë‹¤ë¼ì¼€", pos: [35.7000, 139.7710] },
                { name: "ì• ë‹ˆë©”ì´íŠ¸", pos: [35.7005, 139.7715] },
                { name: "íŠ¸ë ˆì´ë” ë³¸ì ", pos: [35.7010, 139.7718] },
                { name: "ìŠ¤ë£¨ê°€ì•¼", pos: [35.6990, 139.7715] },
                { name: "HEY ì•„ì¼€ì´ë“œ", pos: [35.6995, 139.7705] },
                { name: "GIGO 3í˜¸ê´€", pos: [35.6992, 139.7710] }
            ]
        };

        const RAW_DATA = [
            {
                day: 1,
                items: [
                    { time: "00:00 - 04:00", title: "ì·¨ì¹¨", loc: null, desc: "íœ´ì‹" },
                    { time: "04:00 - 06:00", title: "ê¸°ìƒ ë° ê³µí•­ ì¶œë°œ", loc: null, desc: "ì¤€ë¹„ í›„ ì´ë™" },
                    { time: "06:00 - 07:30", title: "ê³µí•­ ë„ì°© ë° íƒ‘ìŠ¹", loc: LOC.kix, desc: "ìˆ˜ì† ì§„í–‰" },
                    { time: "07:30 - 09:30", title: "ì˜¤ì‚¬ì¹´ ê°„ì‚¬ì´ ê³µí•­ ë„ì°©", loc: LOC.kix, desc: "ì…êµ­ ì‹¬ì‚¬ ë° ì§ ì°¾ê¸°" },
                    { time: "09:30 - 09:43", title: "í‘œ êµ¬ë§¤(ë‚œì¹´ì´ ê³µí•­ì„ )", price: 980, loc: LOC.kix, desc: "ë‚œë°”í–‰ í‹°ì¼“ êµ¬ë§¤" },
                    { time: "09:43 - 10:34", title: "ê¸°ì°¨ ì´ë™ (ë‚œë°”ì—­ ë„ì°©)", type: "move", transport: "train", from: LOC.kix, to: LOC.nambaStn, desc: "ë‚œì¹´ì´ ê³µí•­ì„  íƒ‘ìŠ¹" },
                    { time: "10:34 - 10:50", title: "ë‚œë°”ì—­ â†’ ìˆ™ì†Œ (ë„ë³´)", type: "move", transport: "walk", from: LOC.nambaStn, to: LOC.osakaHotel, desc: "ì§ ë³´ê´€í•˜ëŸ¬ ì´ë™" },
                    { time: "10:50 - 11:05", title: "ìˆ™ì†Œ ì§ ë³´ê´€", loc: LOC.osakaHotel, desc: "ì„¸ë¸ì¼ë ˆë¸ ì˜¤ì‚¬ì¹´ ëª¨í† ë§ˆì¹˜ 2ìµ¸ë©”ì " },
                    { time: "11:05 - 11:45", title: "í…ë™ ë§ˆí‚¤ë…¸ ì´ë™ & ì›¨ì´íŒ…", type: "move", transport: "walk", from: LOC.osakaHotel, to: LOC.tendonMakino, desc: "ì ì‹¬ ëŒ€ê¸°" },
                    { time: "11:45 - 12:25", title: "ì ì‹¬: í…ë™ ë§ˆí‚¤ë…¸", price: 2400, loc: LOC.tendonMakino, desc: "í…ë™ ìŒë¯¸" },
                    { time: "12:25 - 12:40", title: "ë´ë´íƒ€ìš´ìœ¼ë¡œ ì´ë™", type: "move", transport: "walk", from: LOC.tendonMakino, to: LOC.dendenTown, desc: "ë„ë³´ ì´ë™" },
                    { time: "12:40 - 14:45", title: "ë´ë´íƒ€ìš´ ê´€ëŒ", loc: LOC.dendenTown, pois: POIS.denden, desc: "í‚¤ì¦ˆëœë“œ, ì •ê¸€, ìŠˆí¼í¬í…Œì´í† , ì• ë‹ˆë©”ì´íŠ¸, ì˜¤íƒ€ë¡œë“œ" },
                    { time: "14:45 - 15:00", title: "ë‚œë°”ë¡œ ë³µê·€", type: "move", transport: "walk", from: LOC.dendenTown, to: LOC.nambaStn, desc: "ë„ë³´ ì´ë™" },
                    { time: "15:00 - 15:15", title: "í›„ë°œëŒ€ í•©ë¥˜", loc: LOC.nambaStn, desc: "ì¼í–‰ ë§Œë‚¨" },
                    { time: "15:15 - 15:30", title: "ê¸€ë¦¬ì½”ìƒìœ¼ë¡œ ì´ë™", type: "move", transport: "walk", from: LOC.nambaStn, to: LOC.glicoMan, desc: "ë„ë³´ ì´ë™" },
                    { time: "15:30 - 16:15", title: "ê¸€ë¦¬ì½”ìƒ êµ¬ê²½", loc: LOC.glicoMan, desc: "ë„í†¤ë³´ë¦¬ ë©”ì¸ í¬í† ì¡´" },
                    { time: "16:15 - 16:45", title: "ê°„íŒ íˆ¬ì–´ (êµ¬ë¡œëª¬ ì´ë™)", type: "move", transport: "walk", from: LOC.glicoMan, to: LOC.kuromon, pois: POIS.dotonbori_views, desc: "ì¹´ë‹ˆë„ë¼ì¿ , í‚¨ë¥˜ë¼ë©˜, ê²ë¡œì¿ ìŠ¤ì‹œ ë“±" },
                    { time: "16:45 - 17:45", title: "êµ¬ë¡œëª¬ ì‹œì¥ êµ¬ê²½", loc: LOC.kuromon, pois: POIS.kuromon, desc: "ë§ˆêµ¬ë¡œì•¼ ì¿ ë¡œê¸´(ì°¸ì¹˜), ë§ˆë£¨ì  , ê°€ë¦¬ë¹„, í™”ì´íŠ¸ ë”¸ê¸°" },
                    { time: "17:45 - 18:00", title: "ì•„ë¶€ë¦¬ì•¼ë¡œ ì´ë™", type: "move", transport: "walk", from: LOC.kuromon, to: LOC.aburiya, desc: "ì €ë… ì¥ì†Œ ì´ë™" },
                    { time: "18:00 - 19:30", title: "ì €ë…: ì•„ë¶€ë¦¬ì•¼", price: 4900, loc: LOC.aburiya, desc: "ì•¼í‚¤ë‹ˆì¿  ì‹ì‚¬" },
                    { time: "19:30 - 21:00", title: "ë„í†¤ë³´ë¦¬ ì•¼ê²½ & ê°„ì‹", loc: LOC.dotonbori, desc: "ì•¼ê²½ ê°ìƒ ë° ì£¼ì „ë¶€ë¦¬" },
                    { time: "21:00 - 22:00", title: "ì•¼ì‹: ìŠ¤ë¯¸ë¹„ì•¼í‚¤í† ë¦¬í† ", loc: LOC.sumibi, desc: "ê¼¬ì¹˜êµ¬ì´" },
                    { time: "22:00 - 22:15", title: "ìˆ™ì†Œ ë³µê·€", type: "move", transport: "walk", from: LOC.sumibi, to: LOC.osakaHotel, desc: "ë„ë³´ ì´ë™" },
                    { time: "22:15 - 24:00", title: "ì·¨ì¹¨", loc: LOC.osakaHotel, desc: "íœ´ì‹" }
                ]
            },
            {
                day: 2,
                items: [
                    { time: "00:00 - 05:00", title: "ì·¨ì¹¨", loc: LOC.osakaHotel, desc: "íœ´ì‹" },
                    { time: "05:00 - 06:00", title: "ê¸°ìƒ ë° ì„¸ë©´", loc: LOC.osakaHotel, desc: "ì¤€ë¹„" },
                    { time: "06:00 - 06:15", title: "ë‚œë°”ì—­ìœ¼ë¡œ ì´ë™", type: "move", transport: "walk", from: LOC.osakaHotel, to: LOC.nambaStn, desc: "ë„ë³´ ì´ë™" },
                    { time: "06:15 - 07:15", title: "USJ ê²Œì´íŠ¸ë¡œ ì´ë™", type: "move", transport: "train", from: LOC.nambaStn, to: LOC.usj, desc: "ì „ì²  ì´ë™" },
                    { time: "07:15 - 08:15", title: "ì˜¤í”ˆ ëŒ€ê¸°", loc: LOC.usj, desc: "ì…ì¥ ëŒ€ê¸°" },
                    { time: "08:15 - 10:30", title: "USJ 1ë¶€ (ë‹Œí…ë„/í•´ë¦¬í¬í„°)", loc: LOC.usj, pois: POIS.usj, desc: "ìŠˆí¼ ë‹Œí…ë„ ì›”ë“œ, ìœ„ì €ë”© ì›”ë“œ ë“±" },
                    { time: "10:30 - 11:30", title: "ì ì‹¬ì‹ì‚¬", price: 2000, loc: LOC.usj, desc: "íŒŒí¬ ë‚´ ì‹ì‚¬" },
                    { time: "11:30 - 19:30", title: "USJ 2ë¶€ (ì–´íŠ¸ë™ì…˜)", loc: LOC.usj, desc: "ë¯¸ë‹ˆì–¸, ì¥¬ë¼ê¸°, í—ë¦¬ìš°ë“œ, ì›Œí„°ì›”ë“œ ë“±" },
                    { time: "19:30 - 20:30", title: "ë‚œë°”ë¡œ ì´ë™", type: "move", transport: "train", from: LOC.usj, to: LOC.nambaStn, desc: "ì „ì²  ì´ë™" },
                    { time: "20:30 - 20:45", title: "í›„ì¿ íƒ€ë¡œ ë³¸ì  ì´ë™", type: "move", transport: "walk", from: LOC.nambaStn, to: LOC.fukutaro, desc: "ë„ë³´ ì´ë™" },
                    { time: "20:45 - 22:00", title: "ì €ë…: í›„ì¿ íƒ€ë¡œ ë³¸ì ", price: 2500, loc: LOC.fukutaro, desc: "ì˜¤ì½”ë…¸ë¯¸ì•¼í‚¤ (ì›¨ì´íŒ… ê°€ëŠ¥ì„± ìˆìŒ)" },
                    { time: "22:00 - 22:15", title: "ìˆ™ì†Œë¡œ ì´ë™", type: "move", transport: "walk", from: LOC.fukutaro, to: LOC.osakaHotel, desc: "ë„ë³´ ë³µê·€" },
                    { time: "22:15 - 24:00", title: "íœ´ì‹ ë° ì·¨ì¹¨", loc: LOC.osakaHotel, desc: "íœ´ì‹" }
                ]
            },
            {
                day: 3,
                items: [
                    { time: "00:00 - 06:00", title: "ì·¨ì¹¨", loc: LOC.osakaHotel, desc: "íœ´ì‹" },
                    { time: "06:00 - 07:00", title: "ê¸°ìƒ ë° ì•„ì¹¨ì‹ì‚¬", price: 780, loc: LOC.nambaStn, desc: "ì‹ íŒŒì¹˜ ì‹ë‹¹, í•˜ì½”ìœ ë©” ë“± ì¶”ì²œ" },
                    { time: "07:00 - 07:15", title: "ë‚œë°”ì—­ìœ¼ë¡œ ì´ë™", type: "move", transport: "walk", from: LOC.osakaHotel, to: LOC.nambaStn, desc: "ì´ë™" },
                    { time: "07:15 - 08:45", title: "í›„ì‹œë¯¸ ì´ë‚˜ë¦¬ ì‹ ì‚¬ë¡œ ì´ë™", type: "move", transport: "train", from: LOC.nambaStn, to: LOC.fushimiInari, desc: "êµí† í–‰ ì „ì² " },
                    { time: "08:45 - 10:15", title: "í›„ì‹œë¯¸ ì´ë‚˜ë¦¬ ì‹ ì‚¬", loc: LOC.fushimiInari, pois: POIS.fushimi, desc: "ì˜¤ì¿ ìƒ¤ ë´‰ë°°ì†Œ, ì¿ ë§ˆíƒ€ì¹´ìƒ¤, ìš”ì¸ ì¸ ì§€" },
                    { time: "10:15 - 11:30", title: "ì•¼ë§ˆëª¨í†  ë©˜ì¡°ìš°ë¡œ ì´ë™", type: "move", transport: "train", from: LOC.fushimiInari, to: LOC.yamamoto, desc: "ì „ì² /ë²„ìŠ¤ í™˜ìŠ¹ ì´ë™ (ë‹¤ì†Œ ê±°ë¦¬ ìˆìŒ)" },
                    { time: "11:30 - 12:30", title: "ì ì‹¬: ì•¼ë§ˆëª¨í†  ë©˜ì¡°ìš°", price: 1200, loc: LOC.yamamoto, desc: "ìš°ë™ ë§›ì§‘ (ì˜ˆì•½ í•„ìˆ˜)" },
                    { time: "12:30 - 13:00", title: "ê¸°ìš”ë¯¸ì¦ˆí…Œë¼ë¡œ ì´ë™", type: "move", transport: "train", from: LOC.yamamoto, to: LOC.kiyomizu, desc: "ë²„ìŠ¤/ë„ë³´ ì´ë™" },
                    { time: "13:00 - 14:30", title: "ê¸°ìš”ë¯¸ì¦ˆí…Œë¼ (ì²­ìˆ˜ì‚¬)", loc: LOC.kiyomizu, pois: POIS.kiyomizu, desc: "ë³¸ë‹¹ ë¬´ëŒ€, ì˜¤í† ì™€ í­í¬" },
                    { time: "14:30 - 15:30", title: "ì‚°ë„¨ìì¹´ & ë‹ˆë„¨ìì¹´", loc: LOC.sannenzaka, pois: POIS.sannenzaka, desc: "ê±°ë¦¬ íˆ¬ì–´" },
                    { time: "15:30 - 16:00", title: "ì‚°ì¡° ì˜¤í•˜ì‹œë¡œ ì´ë™", type: "move", transport: "walk", from: LOC.sannenzaka, to: LOC.kamoRiver, desc: "ë„ë³´ ì´ë™" },
                    { time: "16:00 - 16:50", title: "ê°€ëª¨ê°• íœ´ì‹", loc: LOC.kamoRiver, pois: POIS.kamo_cafes, desc: "ìŠ¤íƒ€ë²…ìŠ¤/ë¸”ë£¨ë³´í‹€ í…Œì´í¬ì•„ì›ƒ í›„ í”¼í¬ë‹‰" },
                    { time: "16:50 - 18:00", title: "ì €ë…1: ì¿„ ëª¨ì¸ ë‚˜ë²  íˆë°í† ë¼", price: 3500, loc: LOC.hideatora, desc: "ëª¨ì¸ ë‚˜ë²  ì‹ì‚¬" },
                    { time: "18:00 - 19:30", title: "ê¸°ì˜¨ & í°í† ì´ˆ ê±°ë¦¬", loc: LOC.gion, pois: [...POIS.gion, ...POIS.pontocho], desc: "ë°¤ê±°ë¦¬ êµ¬ê²½" },
                    { time: "19:30 - 20:30", title: "ì €ë…2: í°í† ìµ¸ ì•¼ì†Œí•˜ì¹˜", price: 3000, loc: LOC.yasohachi, desc: "ì´ìì¹´ì•¼" },
                    { time: "20:30 - 22:00", title: "ë‚œë°”ë¡œ ì´ë™", type: "move", transport: "train", from: LOC.yasohachi, to: LOC.nambaStn, desc: "ì˜¤ì‚¬ì¹´ ë³µê·€" },
                    { time: "22:00 - 22:15", title: "ë¼ìš´ë“œì›ìœ¼ë¡œ ì´ë™", type: "move", transport: "walk", from: LOC.nambaStn, to: LOC.roundOne, desc: "ë„ë³´ ì´ë™" },
                    { time: "22:15 - 24:00", title: "ë¼ìš´ë“œì› or íœ´ì‹", loc: LOC.roundOne, desc: "ê²Œì„ ë° ì•¡í‹°ë¹„í‹°" }
                ]
            },
            {
                day: 4,
                items: [
                    { time: "00:00 - 01:00", title: "ë¼ìš´ë“œì› ì¢…ë£Œ í›„ ìˆ™ì†Œ ë³µê·€", type: "move", transport: "walk", from: LOC.roundOne, to: LOC.osakaHotel, desc: "ì‹¬ì•¼ ë„ë³´ ì´ë™" },
                    { time: "01:00 - 09:00", title: "ì·¨ì¹¨", loc: LOC.osakaHotel, desc: "ë§ˆì§€ë§‰ ë°¤" },
                    { time: "09:00 - 10:20", title: "ê¸°ìƒ ë° ì•„ì¹¨(ì½”ë©”ë‹¤)", loc: LOC.nambaStn, desc: "ì½”ë©”ë‹¤ ì»¤í”¼ ë“±" },
                    { time: "10:20 - 10:46", title: "ì‹ ì˜¤ì‚¬ì¹´ ì—­ìœ¼ë¡œ ì´ë™", type: "move", transport: "train", from: LOC.nambaStn, to: LOC.shinOsaka, desc: "ì§€í•˜ì²  ì´ë™" },
                    { time: "10:46 - 11:06", title: "ì—í‚¤ë²¤ êµ¬ë§¤", loc: LOC.shinOsaka, desc: "ê°ì ì·¨í–¥ëŒ€ë¡œ êµ¬ë§¤" },
                    { time: "11:06 - 13:33", title: "ë„ì¿„í–‰ ì‹ ì¹¸ì„¼ ì´ë™", type: "move", transport: "train", from: LOC.shinOsaka, to: LOC.tokyoStn, desc: "ê¸°ì°¨ ë‚´ ì—í‚¤ë²¤ ì‹ì‚¬" },
                    { time: "13:33 - 14:00", title: "ë„ì¿„ì—­ â†’ ìˆ™ì†Œ ì´ë™", type: "move", transport: "train", from: LOC.tokyoStn, to: LOC.uenoHotel, desc: "ìš°ì—ë…¸ ì´ë™" },
                    { time: "14:00 - 14:20", title: "ë„êµ¬ê±°ë¦¬ ì´ë™", type: "move", transport: "walk", from: LOC.uenoHotel, to: LOC.kappabashi, desc: "ë„ë³´" },
                    { time: "14:20 - 15:20", title: "ê°“íŒŒë°”ì‹œ ë„êµ¬ê±°ë¦¬", loc: LOC.kappabashi, pois: POIS.kappabashi, desc: "ë‹ˆì´ë¯¸, ë§ˆì§€ë§ˆì•¼, ìœ ë‹ˆì˜¨ ë“± ê´€ëŒ" },
                    { time: "15:20 - 15:40", title: "ì„¼ì†Œì§€ë¡œ ì´ë™", type: "move", transport: "walk", from: LOC.kappabashi, to: LOC.sensoji, desc: "ë„ë³´" },
                    { time: "15:40 - 17:00", title: "ì„¼ì†Œì§€ & ë‚˜ì¹´ë¯¸ì„¸ë„ë¦¬", loc: LOC.sensoji, pois: POIS.sensoji, desc: "ì¹´ë¯¸ë‚˜ë¦¬ëª¬, ë°€ë ˆ ë©”ë ˆ(ì• í”ŒíŒŒì´), ë©˜ì¹˜ì¹´ì¸  ë“±" },
                    { time: "17:00 - 17:30", title: "ì•„í‚¤í•˜ë°”ë¼ë¡œ ì´ë™", type: "move", transport: "train", from: LOC.sensoji, to: LOC.akihabara, desc: "ì „ì² /ë„ë³´" },
                    { time: "17:30 - 18:30", title: "ì•„í‚¤í•˜ë°”ë¼ êµ¬ê²½", loc: LOC.akihabara, pois: POIS.akihabara, desc: "ë¼ë””ì˜¤íšŒê´€, ì• ë‹ˆë©”ì´íŠ¸ ë“±" },
                    { 
                        time: "18:30 - 19:30", 
                        title: "ì €ë…: ë¼ë©˜ (íŒ€ ë¶„ë¦¬)", 
                        type: "split_dinner",
                        routes: [
                            { name: "AíŒ€: ë©˜ë„ì½”ë¡œ í˜¼ë‹¤", to: LOC.honda, color: "#ef4444", desc: "ì‡¼ìœ  ë¼ë©˜" },
                            { name: "BíŒ€: í˜¸íƒ€í…Œ ë¹„ìš”ë¦¬", to: LOC.hotate, color: "#22c55e", desc: "ê°€ë¦¬ë¹„ ë¼ë©˜" }
                        ],
                        price: 1300,
                        desc: "ê°ì ì›¨ì´íŒ… í›„ ì‹ì‚¬"
                    },
                    { 
                        time: "19:30 - 20:30", 
                        title: "GIGO ê²Œì„ & ê°€ì± ", 
                        loc: LOC.gigo,
                        type: "merge", 
                        froms: [LOC.honda, LOC.hotate], 
                        desc: "ë‹¤ì‹œ í•©ë¥˜í•˜ì—¬ ê²Œì„",
                        price: 2000
                    },
                    { time: "20:30 - 21:00", title: "ì•„ë©”ìš”ì½”ë¡œ ì´ë™", type: "move", transport: "walk", from: LOC.gigo, to: LOC.ameyoko, desc: "ë„ë³´" },
                    { time: "21:00 - 24:00", title: "ì´ìì¹´ì•¼ ë’·í’€ì´", loc: LOC.ameyoko, pois: POIS.ameyoko, desc: "ë§¤ì¥ ì°¾ì•„ì•¼ í•¨" }
                ]
            }
        ];

        // --- 2. LOGIC ---
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        const SCHEDULE = RAW_DATA;
        
        // Multi-select Logic
        let selectedIndices = new Set();
        let longPressTimer;
        let isLongPressTriggered = false;
        let currentDay = 0;

        // --- 3. MAP ---
        const map = L.map('map', { zoomControl: false }).setView([34.6618, 135.5021], 13);
        L.control.zoom({ position: 'topright' }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO', maxZoom: 19
        }).addTo(map);

        let layers = [];
        const icons = {
            start: L.divIcon({ html: '<div class="bg-indigo-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold shadow-lg border-2 border-white">S</div>', className: 'bg-transparent', iconSize: [32, 32], iconAnchor: [16, 32] }),
            end: L.divIcon({ html: '<div class="bg-slate-700 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold shadow-lg border-2 border-white">E</div>', className: 'bg-transparent', iconSize: [32, 32], iconAnchor: [16, 32] }),
            poi: L.divIcon({ className: 'pulse-icon' }),
            poiBlue: L.divIcon({ className: 'pulse-icon-blue' }),
            splitA: L.divIcon({ html: '<div class="bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold border-2 border-white">A</div>', className: 'bg-transparent', iconSize: [24,24] }),
            splitB: L.divIcon({ html: '<div class="bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold border-2 border-white">B</div>', className: 'bg-transparent', iconSize: [24,24] })
        };

        function getNumberIcon(num) {
            return L.divIcon({ 
                html: `<div class="number-icon">${num}</div>`, 
                className: 'bg-transparent', 
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
        }

        async function drawRoute(from, to, color = '#3b82f6', dashed = false) {
            const options = { color: color, weight: 5, opacity: 0.8, lineJoin: 'round' };
            if(dashed) options.dashArray = '1, 10';

            // Show straight line first or dashed line
            const line = L.polyline([from, to], dashed ? { ...options, dashArray: '8, 8', weight: 4, color: '#cbd5e1' } : options).addTo(map);
            if(dashed) { layers.push(line); return; } // just return dashed

            layers.push(line);
            
            try {
                const dist = getDistance(from[0], from[1], to[0], to[1]);
                if (dist > 100) { map.fitBounds(line.getBounds(), { padding: [50, 50] }); return; }

                const resp = await fetch(`https://router.project-osrm.org/route/v1/foot/${from[1]},${from[0]};${to[1]},${to[0]}?overview=full&geometries=geojson`);
                const data = await resp.json();
                if(data.code === 'Ok') {
                    const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                    map.removeLayer(line);
                    const route = L.polyline(coords, options).addTo(map);
                    layers.push(route);
                    map.fitBounds(route.getBounds(), { padding: [50, 50] });
                }
            } catch(e) {}
        }

        // --- 4. SELECTION & MAP UPDATE ---
        function clearSelection() {
            selectedIndices.clear();
            document.querySelectorAll('.schedule-item').forEach(e => e.classList.remove('multi-selected'));
            document.getElementById('btn-reset-select').classList.add('hidden');
            document.getElementById('map-info').classList.add('hidden');
            layers.forEach(l => map.removeLayer(l)); layers = [];
            
            // Revert to start location view
            const first = SCHEDULE[currentDay].items.find(i => i.loc);
            if(first) map.setView(first.loc, 13);
        }

        function updateMultiSelectMap() {
            layers.forEach(l => map.removeLayer(l)); layers = [];
            document.getElementById('map-info').classList.add('hidden');

            const dayItems = SCHEDULE[currentDay].items;
            const indices = Array.from(selectedIndices).sort((a,b) => a-b);
            
            if (indices.length === 0) return;

            const routePoints = [];
            
            indices.forEach((idx, i) => {
                const item = dayItems[idx];
                const pos = item.loc || item.to || item.from;
                
                if (pos) {
                    routePoints.push(pos);
                    layers.push(L.marker(pos, { icon: getNumberIcon(i + 1) }).addTo(map));
                }
            });

            if (routePoints.length > 1) {
                // Connect dots with dashed lines for visual sequence
                const pathLine = L.polyline(routePoints, { color: '#3b82f6', weight: 4, dashArray: '10, 10', opacity: 0.8 }).addTo(map);
                layers.push(pathLine);
                map.fitBounds(pathLine.getBounds(), { padding: [50, 50] });
            } else if (routePoints.length === 1) {
                map.setView(routePoints[0], 15);
            }
        }

        function handleItemClick(index, card) {
            const dayData = SCHEDULE[currentDay];
            const item = dayData.items[index];

            // 1. If Multi-select Mode is Active or User just triggered Long Press
            if (selectedIndices.size > 0 || isLongPressTriggered) {
                if (selectedIndices.has(index)) {
                    selectedIndices.delete(index);
                    card.classList.remove('multi-selected');
                } else {
                    selectedIndices.add(index);
                    card.classList.add('multi-selected');
                }

                if (selectedIndices.size === 0) {
                    clearSelection();
                } else {
                    document.getElementById('btn-reset-select').classList.remove('hidden');
                    updateMultiSelectMap();
                }
                return;
            }

            // 2. Normal Single Click Mode
            document.querySelectorAll('.schedule-item').forEach(e => e.classList.remove('active-card', 'multi-selected'));
            card.classList.add('active-card');
            
            // Render Single Item Details (Existing Logic)
            layers.forEach(l => map.removeLayer(l)); layers = [];
            
            const infoBox = document.getElementById('map-info');
            const infoContent = document.getElementById('info-content');
            const toggleIcon = document.getElementById('toggle-icon');
            
            infoBox.classList.remove('hidden', 'opacity-0', 'translate-y-[-20px]');
            infoContent.classList.add('collapsed-content');
            toggleIcon.classList.add('rotate-180');

            document.getElementById('info-title').innerText = item.title;
            
            let infoHtml = `<p class="mb-2">${item.desc || ''}</p>`;
            if(item.time) infoHtml += `<p class="text-xs text-gray-400 mb-2"><i class="far fa-clock"></i> ${item.time}</p>`;

            const isMove = item.type === 'move';
            const isSplit = item.type === 'split_dinner';

            if (isSplit) {
                const start = LOC.akihabara;
                item.routes.forEach(r => {
                    drawRoute(start, r.to, r.color);
                    layers.push(L.marker(r.to, {icon: r.name.includes('A')?icons.splitA:icons.splitB}).addTo(map).bindPopup(r.name));
                });
                layers.push(L.marker(start, {icon: icons.start}).addTo(map));
            } else if (item.type === 'merge') {
                item.froms.forEach((f, idx) => {
                    drawRoute(f, item.loc, idx===0?'#ef4444':'#22c55e');
                    layers.push(L.marker(f, {icon: idx===0?icons.splitA:icons.splitB}).addTo(map));
                });
                layers.push(L.marker(item.loc, {icon: icons.end}).addTo(map).bindPopup("GIGO ì§‘ê²°"));
            } else if (isMove) {
                drawRoute(item.from, item.to, item.transport==='train'?'#8b5cf6':'#3b82f6');
                layers.push(L.marker(item.from, {icon: icons.start}).addTo(map));
                layers.push(L.marker(item.to, {icon: icons.end}).addTo(map));
            } else {
                if(item.loc) {
                    map.setView(item.loc, 15);
                    layers.push(L.marker(item.loc, {icon: icons.start}).addTo(map));
                }
                if(item.pois) {
                    const bounds = L.latLngBounds(item.pois.map(p => p.pos));
                    item.pois.forEach(p => {
                        layers.push(L.marker(p.pos, {icon: icons.poi}).addTo(map).bindTooltip(p.name, {permanent:true, direction:'top', className:'text-xs font-bold bg-white border px-1 rounded shadow'}));
                    });
                    map.fitBounds(bounds, {padding:[50,50]});
                    
                    infoHtml += `<div class="grid grid-cols-2 gap-1 mt-2">`;
                    item.pois.forEach(p => infoHtml += `<span class="text-xs bg-gray-50 px-2 py-1 rounded border">ğŸ“ ${p.name}</span>`);
                    infoHtml += `</div>`;
                }
            }
            document.getElementById('info-content').innerHTML = infoHtml;
        }


        // --- 5. RENDER ---
        function formatMoney(n) { return n ? `Â¥${n.toLocaleString()}` : ''; }

        function toggleInfo() {
            const content = document.getElementById('info-content');
            const icon = document.getElementById('toggle-icon');
            if(content.classList.contains('collapsed-content')) {
                content.classList.remove('collapsed-content');
                icon.classList.remove('rotate-180');
            } else {
                content.classList.add('collapsed-content');
                icon.classList.add('rotate-180');
            }
        }

        function closeInfo() {
            document.getElementById('map-info').classList.add('hidden', 'opacity-0', 'translate-y-[-20px]');
        }

        function renderTimeline(dayIdx) {
            currentDay = dayIdx;
            clearSelection(); // Reset selection on day change

            const list = document.getElementById('schedule-list');
            const dayData = SCHEDULE[dayIdx];
            list.innerHTML = '';
            
            document.getElementById('split-legend').classList.toggle('hidden', dayIdx !== 3);
            let total = 0; dayData.items.forEach(i => total += (i.price||0));
            document.getElementById('total-cost-desktop').innerText = `ì´ ì˜ˆìƒ ë¹„ìš©: ${formatMoney(total)}`;
            document.getElementById('total-cost-mobile').innerText = `Total: ${formatMoney(total)}`;

            // Hide hint after 3 seconds
            setTimeout(() => { document.getElementById('multi-select-hint').classList.add('opacity-0'); }, 3000);

            dayData.items.forEach((item, index) => {
                const isMove = item.type === 'move';
                const isSplit = item.type === 'split_dinner';
                
                const card = document.createElement('div');
                card.className = `schedule-item p-3 md:p-4 rounded-xl shadow-sm border border-gray-100 cursor-pointer relative bg-white my-2 select-none ${isMove ? 'bg-slate-50 border-dashed opacity-80' : ''}`;
                
                let iconEl = `<div class="w-10 h-10 rounded-full bg-indigo-50 text-indigo-500 flex items-center justify-center"><i class="fas fa-map-pin"></i></div>`;
                if(item.title.includes('ê¸°ìƒ') || item.title.includes('ì·¨ì¹¨')) iconEl = `<div class="w-10 h-10 rounded-full bg-yellow-50 text-yellow-500 flex items-center justify-center"><i class="fas fa-bed"></i></div>`;
                else if(isMove) iconEl = `<div class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center"><i class="fas fa-${item.transport === 'train' ? 'train' : 'person-walking'}"></i></div>`;
                else if(item.title.includes('ì‹ì‚¬') || item.title.includes('ì €ë…') || item.title.includes('ì ì‹¬')) iconEl = `<div class="w-10 h-10 rounded-full bg-orange-50 text-orange-500 flex items-center justify-center"><i class="fas fa-utensils"></i></div>`;
                else if(isSplit) iconEl = `<div class="w-10 h-10 rounded-full bg-pink-50 text-pink-500 flex items-center justify-center"><i class="fas fa-code-branch"></i></div>`;

                let timeStr = item.time ? item.time.replace(' - ', '<br>~<br>') : '';
                
                let content = `<div class="flex items-center gap-3">`;
                content += `<div class="flex flex-col items-center gap-1 min-w-[50px] leading-tight text-center"><span class="text-[10px] font-bold text-gray-500">${timeStr}</span>${iconEl}</div>`;
                content += `<div class="flex-1 min-w-0"><div class="flex justify-between items-start"><h4 class="font-bold text-gray-800 truncate ${isMove ? 'text-sm text-gray-500' : ''}">${item.title}</h4>`;
                if(item.price) content += `<span class="text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded font-bold ml-1 shrink-0">${formatMoney(item.price)}</span>`;
                content += `</div>`;
                
                if(item.desc) content += `<p class="text-xs text-gray-500 mt-1 truncate">${item.desc}</p>`;
                if(isMove && item.dist) content += `<p class="text-[10px] text-blue-500 font-semibold mt-0.5"><i class="fas fa-route"></i> ${item.dist}km ì´ë™</p>`;
                
                if(isSplit) content += `<div class="flex gap-2 mt-2"><span class="text-[10px] px-2 py-1 rounded border split-badge-a flex-1 text-center">A: í˜¼ë‹¤</span><span class="text-[10px] px-2 py-1 rounded border split-badge-b flex-1 text-center">B: í˜¸íƒ€í…Œ</span></div>`;
                content += `</div></div>`;
                card.innerHTML = content;

                // --- Long Press Logic ---
                const startEvent = (e) => {
                    isLongPressTriggered = false;
                    longPressTimer = setTimeout(() => {
                        isLongPressTriggered = true;
                        // Haptic feedback if available
                        if (navigator.vibrate) navigator.vibrate(50);
                        handleItemClick(index, card); 
                    }, 500); 
                };

                const clearEvent = () => {
                    clearTimeout(longPressTimer);
                };

                // Mouse Events
                card.addEventListener('mousedown', startEvent);
                card.addEventListener('mouseup', clearEvent);
                card.addEventListener('mouseleave', clearEvent);

                // Touch Events
                card.addEventListener('touchstart', startEvent, {passive: true});
                card.addEventListener('touchend', clearEvent);
                card.addEventListener('touchmove', clearEvent); // Cancel on scroll

                // Click Event (triggers after mouseup/touchend)
                card.onclick = (e) => {
                    if (!isLongPressTriggered) {
                        handleItemClick(index, card);
                    }
                    isLongPressTriggered = false; // Reset
                };

                list.appendChild(card);
            });
        }

        function selectDay(idx) {
            [0,1,2,3].forEach(i => {
                const btn = document.getElementById(`tab-${i}`);
                if(i===idx) { btn.classList.add('text-indigo-600','border-indigo-600'); btn.classList.remove('text-gray-500'); }
                else { btn.classList.remove('text-indigo-600','border-indigo-600'); btn.classList.add('text-gray-500'); }
            });
            renderTimeline(idx);
            
            const first = SCHEDULE[idx].items.find(i => i.loc);
            if(first) map.setView(first.loc, 13);
        }

        selectDay(0);
    </script>
</body>
</html>
